# 並行控制
- 定義：
    - 讓多筆交易可以在同一時間存取同一筆資料
    - 並行控制讓多筆交易在並行的狀況下運作而不會互相干擾，確保交易的孤立性，提高交易效率
- 目的：
    - 多筆交易可同時進行，並不會互相干擾
    - 減低交易的回覆時間
    - 增加交易的產出

# 並行控制不佳所導致的問題
- 遺失更新
- 不一致分析
- 未確認相依

# 遺失更新
- 當多筆交易交錯進行，並針對相同資料項做讀取，可能會使資料項目的內容值不正確
- 會產生遺失更新的排程，一定不是可序列化排程

# 不一致分析
- 又稱**不正確總合**問題
- 一筆交易正在對某些資料項目做聚合函數運算，若此時期中一個資料項目被其他交易修改，造成聚合結果不正確
- 因時間點不一致造成

# 未確認相依
- 交易A已更新某一個資料項，但尚未確認(Commit)時，此資料項又被另一個交易B所存取，但是先前的交易A因故需要撤回(Abort/Rollback)，因此交易B讀到一個不應該讀的值

# 交易並行可能會發生的問題
- 死結
- 活結
- 餓死

# 死結
- 當兩交易進行時，各自都佔有某些資源，卻企圖奪取對方的資源，就會造成一種互相等待對方釋放資源的情形
- 形成死結的必要條件
    - 互斥：同一資源不可被兩個以上的交易共用，資源會被鎖定
    - 持有並等待：各交易都佔有某些資源，並等候其他交易釋放資源
    - 不可搶奪：不可強取已被占用之資源
    - 循環式等待：等待形成迴圈
![](http://i.imgur.com/xkG77zu.png)

# 活結與餓死
- 若交易有**優先權**，優先權較高之交易持續得到資源，而優先權較低的交易一直得不到資源，而進入活結的狀態
- 交易處於活結狀態太久 -> 餓死

# 餓死的問題解決
- 等-死方法 (wait-die)
    - 當交易Ti要求一個被Tj所持有的資源時，去比對兩筆交易的時間戳記，若：
        - Ti時間戳記>Tj，則撤回Ti
        - Ti時間戳記<Tj，則Ti允許等待
    - 基於**不可強奪**為基礎
- 傷-等方法 (wound-wait scheme)
    - 等-死的相反
    - 當交易Ti要求一個被Tj所持有的資源時，去比對兩筆交易的時間戳記，若：
        - Ti時間戳記<Tj，直接搶奪Tj資源，Tj撤回
        - Ti時間戳記>Tj，則Ti允許等待

# 並型控制的技術
- 鎖定：當交易欲存取某資料項目時，必須將此資料鎖住，直到存取結束才解鎖
- 時間戳記：每個交易依照其進入資料庫系統的先後，給予一個時間戳記，以時間戳記的大小來判斷交易的優先權
- 多重版本並行控制：
    - 以時間為基礎，會在每次資料項目被修改時，保留舊的版本
    - 所以在並行執行時，會自動選擇適合的版本避免不一致的情況
    - 較浪費空間
- 樂觀並行控制
    - 不在交易期間進行檢查，而是在交易完成後才開始檢查
    - 若交易違反可序列化的結果，選擇影響較小的交易做撤回

# 鎖定
- 用一個變數記錄資料項目的狀態，並決定何種動作**允許**何種**不允許**
    - 二元鎖定
    - 共享互斥鎖定
    - 兩階段鎖定

# 二元鎖定
- 交易欲存取資料項目X時，即將X鎖定，直到存取完畢，再解除對X的鎖定
- 將資料項分成兩種狀態
    - 鎖定(Lock)
    - 解除鎖定(Unlock)
- 缺點：
    - 不能保證排程為可序列化
    - 可能產生死結
    - 可能產生活結或餓死狀態
    - 並行程度不佳
![](http://i.mgur.com/LlntAyT.png)

# 共享互斥鎖定
- 改善二元鎖定過於嚴格、並行度不佳特性
- 若只是從事read功能，並不需要鎖定資料項；只有在從事write才需要所定資料項
- 共享互斥鎖定又稱多元鎖定，將二元鎖定中的Lock分為共享鎖定與互斥鎖定兩種，較二元鎖定有彈性。
- 將資料項分為三種狀態
    - 共享鎖定：又稱讀取鎖定，仍可讀取
    - 互斥鎖定：又稱寫入鎖定，不能讀取或寫入
    - 解除鎖定：可以被讀取或寫入
- 鎖定的升級與降級
    - 升級：unlock -> read lock -> write lock
    - 降級：write lock -> read lock -> unlock
- 缺點：
    - 不能保證排程為可序列化
    - 可能產生死結、活結和餓死

![](http://.imgur.com/PlQoNwL.png)

